---
title: "Correlation comparison"
author: "Janica Bühler"
date: "18 März 2021"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(plyr)
library(dplyr)
library(tidyverse)
library(latex2exp)
library(zoo)
library(nest)
library(PaleoSpec)
source("Functions/projection_ptlyr.R")
source("Functions/STACYmap_PMIL.R")
source("Functions/STACYmap_PMIL_NAgrid.R")
```


We compare the correlation between simulated d18O and temperature/precipitation also to the speleothems:

First we calculate the correlation fields and export them, so we don't have to recalculate them everytime. 

```{r}
for(Model in c("HadCM3", "ECHAM5", "CCSM", "CESM", "GISS")){
#for(Model in c("GISS")){  
  print(Model)
  if(Model == "HadCM3"){
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/HadCM3_tsurf_850-1850.nc")
    temp_field <- ncdf4::ncvar_get(ncf)
    ncdf4::nc_close(ncf)
  
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/HadCM3_prec_850-1850.nc")
    prec_field <- ncdf4::ncvar_get(ncf)*86400
    ncdf4::nc_close(ncf)
  
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/HadCM3_d18O_850-1850.nc")
    isot_field <- ncdf4::ncvar_get(ncf, "dO18")
    ncdf4::nc_close(ncf)
    
    isot_field[prec_field<0.1/360] = NA
    
  }else if(Model == "ECHAM5"){
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/ECHAM5_tsurf_K_850-1849.nc")
    temp_field <- ncdf4::ncvar_get(ncf)-273.15
    ncdf4::nc_close(ncf)
  
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/ECHAM5_prec_mm_850-1849.nc")
    prec_field <- ncdf4::ncvar_get(ncf)*12
    ncdf4::nc_close(ncf)
  
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/ECHAM5_d18O_850-1849.nc")
    isot_field <- ncdf4::ncvar_get(ncf)
    ncdf4::nc_close(ncf)
  }else if(Model == "GISS"){
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/GISS_tsurf_850-1849.nc")
    temp_field <- ncdf4::ncvar_get(ncf)[,90:1,]
    ncdf4::nc_close(ncf)
    
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/GISS_prec_850-1849.nc")
    prec_field <- ncdf4::ncvar_get(ncf)[,90:1,]*360
    ncdf4::nc_close(ncf)
    
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/GISS_d18O_850-1849.nc")
    isot_field <- ncdf4::ncvar_get(ncf)[,90:1,]
    ncdf4::nc_close(ncf)
    remove(ncf)
  }else if(Model == "CESM"){
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/CESM_tsurf_850-1850.nc")
    temp_field <- ncdf4::ncvar_get(ncf)[,96:1,1:12000]-273.15
    ncdf4::nc_close(ncf)
    
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/CESM_prec_850-1850.nc")
    prec_field <- ncdf4::ncvar_get(ncf)[,96:1,1:12000]*86400*365.25*1000
    ncdf4::nc_close(ncf)
  
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/CESM_d18O_850-1850.nc")
    isot_field <- ncdf4::ncvar_get(ncf)[,96:1,1:12000]
    ncdf4::nc_close(ncf)
  }else if(Model == "CCSM"){
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/CCSM_t2m_850-1849.nc")
    temp_field <- ncdf4::ncvar_get(ncf)[,94:1,1:12000]-273.15
    ncdf4::nc_close(ncf)
    
    ncf <- ncdf4::nc_open("/home/ginnyweasley/Dokumente/01_Promotion/07_R_Code/202009_SISAL1k/Data/Sim_data/CCSM_prec_850-1849.nc")
    prec_field <- ncdf4::ncvar_get(ncf)[,94:1,1:12000]*86400*360
    ncdf4::nc_close(ncf)
    
    ncf <- ncdf4::nc_open("~/Dokumente/01_Promotion/06_Daten/11_CCSM/monthly/flxmon-prate1sfc.nc")
    ISOT2 <- ncdf4::ncvar_get(ncf)[,94:1,1:12000]*86400*360
    ncdf4::nc_close(ncf)
    
    isot_field = (ISOT2/prec_field -1)*1000
    isot_field[prec_field < 0.5] = NA
    rm(ISOT2)
  }
  
  CORR_FIELD <- list(TEMP = array(dim = dim(temp_field)[c(1,2)]), PREC = array(dim = dim(temp_field)[c(1,2)]),
                     TEMP_P = array(dim = dim(temp_field)[c(1,2)]), PREC_P = array(dim = dim(temp_field)[c(1,2)]))
  
  
  #Corr Fields:
  for(lon in 1:dim(temp_field)[1]){
    if(lon%%10==0){print(lon)}
    for(lat in 1:dim(temp_field)[2]){
      temp = rollapply(temp_field[lon,lat,],3,mean, by = 12, na.rm = T)
      prec = rollapply(prec_field[lon,lat,],3,mean, by = 12, na.rm = T)
      isot = rollapply(isot_field[lon,lat,],3,mean, by = 12, na.rm = T)
      
      if(sum(is.na(isot))>500){next}
      
      CORR = cor.test(temp,isot, na.rm = T)
      CORR_FIELD$TEMP[lon,lat] = CORR$estimate[[1]]
      CORR_FIELD$TEMP_P[lon,lat] = CORR$p.value
      
      CORR = cor.test(prec,isot, na.rm = T)
      CORR_FIELD$PREC[lon,lat] = CORR$estimate[[1]]
      CORR_FIELD$PREC_P[lon,lat] = CORR$p.value
      
    }
  }
  
  if(Model == "ECHAM5"){
    CORR_FIELD$TEMP = rbind(CORR_FIELD$TEMP[49:96,],CORR_FIELD$TEMP[1:48,])
      CORR_FIELD$TEMP_P = rbind(CORR_FIELD$TEMP_P[49:96,],CORR_FIELD$TEMP_P[1:48,])
    CORR_FIELD$PREC = rbind(CORR_FIELD$PREC[49:96,],CORR_FIELD$PREC[1:48,])
    CORR_FIELD$PREC_P = rbind(CORR_FIELD$PREC_P[49:96,],CORR_FIELD$PREC_P[1:48,])
  }else if(Model == "HadCM3"){
    CORR_FIELD$TEMP = rbind(CORR_FIELD$TEMP[49:96,],CORR_FIELD$TEMP[1:48,])
    CORR_FIELD$TEMP_P = rbind(CORR_FIELD$TEMP_P[49:96,],CORR_FIELD$TEMP_P[1:48,])
    CORR_FIELD$PREC = rbind(CORR_FIELD$PREC[49:96,],CORR_FIELD$PREC[1:48,])
    CORR_FIELD$PREC_P = rbind(CORR_FIELD$PREC_P[49:96,],CORR_FIELD$PREC_P[1:48,])
  }else if(Model == "CCSM"){
    CORR_FIELD$TEMP = rbind(CORR_FIELD$TEMP[97:192,],CORR_FIELD$TEMP[1:96,])
    CORR_FIELD$TEMP_P = rbind(CORR_FIELD$TEMP_P[97:192,],CORR_FIELD$TEMP_P[1:96,])
    CORR_FIELD$PREC = rbind(CORR_FIELD$PREC[97:192,],CORR_FIELD$PREC[1:96,])
    CORR_FIELD$PREC_P = rbind(CORR_FIELD$PREC_P[97:192,],CORR_FIELD$PREC_P[1:96,])
  }else if(Model == "CESM"){
    CORR_FIELD$TEMP = rbind(CORR_FIELD$TEMP[73:144,],CORR_FIELD$TEMP[1:72,])
    CORR_FIELD$TEMP_P = rbind(CORR_FIELD$TEMP_P[73:144,],CORR_FIELD$TEMP_P[1:72,])
    CORR_FIELD$PREC = rbind(CORR_FIELD$PREC[73:144,],CORR_FIELD$PREC[1:72,])
    CORR_FIELD$PREC_P = rbind(CORR_FIELD$PREC_P[73:144,],CORR_FIELD$PREC_P[1:72,])
  }else if(Model == "GISS"){
    CORR_FIELD$TEMP = CORR_FIELD$TEMP
    CORR_FIELD$TEMP_P = CORR_FIELD$TEMP_P
    CORR_FIELD$PREC = CORR_FIELD$PREC
    CORR_FIELD$PREC_P = CORR_FIELD$PREC_P
  }
  
  save(CORR_FIELD, file = paste0("Data/Corr_field_",Model,".RData"))
}



```

Hier follows the pointwise correlation for the cave locations:
```{r message=FALSE, warning=FALSE}
CORR_CAVE = list()
ENTITY_INFO <- read.csv("Data/SISAL1k_entity_info.csv")

for(Model in c("HadCM3", "ECHAM5", "GISS", "CCSM", "CESM")){
  name = Model
  if(Model =="CCSM"){name = "isoGSM"}
  
  DATA <- read.csv(paste0("Data/SISAL1k_ds_",name,".csv"))
  
  CORR_CAVE[[Model]] <- list(entity_id = numeric(length(ENTITY_INFO$entity_id)),
                  lon = numeric(length(ENTITY_INFO$entity_id)),
                  lat = numeric(length(ENTITY_INFO$entity_id)))

  for(var in c("TEMP", "PREC")){
    CORR_CAVE[[Model]][[paste0("CORR_",var)]] <- numeric(length(ENTITY_INFO$entity_id))
    CORR_CAVE[[Model]][[paste0("p_", var)]] <- numeric(length(ENTITY_INFO$entity_id))
    for(ii in 1:length(ENTITY_INFO$entity_id)){
      entity = ENTITY_INFO$entity_id[ii]
      CORR_CAVE[[Model]]$entity_id[ii] = entity
      CORR_CAVE[[Model]]$lon[ii] = ENTITY_INFO$longitude[ii]
      CORR_CAVE[[Model]]$lat[ii] = ENTITY_INFO$latitude[ii]
      data_rec = DATA %>% filter(entity_id == entity)
      # zoo cannot handle objects where order.by has two elements which is why they are sorted out here (no better option found)
      double_time <- data_rec %>% group_by(year_BP) %>% count() %>% filter(n>1)
      data_rec <- data_rec %>% filter(!year_BP %in% double_time$year_BP)
      if(length(data_rec$year_BP)>4){
        record = zoo(x = data_rec$d18O_measurement, order.by = data_rec$year_BP)
        sim = zoo(x = na.omit(data_rec[[paste0(var)]]), order.by = data_rec$year_BP[!is.na(data_rec[[paste0(var)]])])
        COR <- nexcf_ci(record, sim)
        
        CORR_CAVE[[Model]][[paste0("CORR_",var)]][ii] = COR$rxy
        CORR_CAVE[[Model]][[paste0("p_",var)]][ii] = COR$pval
        CORR_CAVE[[Model]][[paste0("neff_",var)]][ii] = COR$neff
        CORR_CAVE[[Model]][[paste0("neff_ratio",var)]][ii] = COR$neff/length(data_rec$d18O_measurement)
      }else{
        CORR_CAVE[[Model]][[paste0("CORR_",var)]][ii] = NA
        CORR_CAVE[[Model]][[paste0("p_",var)]][ii] = NA
        CORR_CAVE[[Model]][[paste0("neff_",var)]][ii] = NA
        CORR_CAVE[[Model]][[paste0("neff_ratio",var)]][ii] = NA
      }
    }
  }
}
```

get an agreement plot:

```{r}
#First all plots need to be of the same resolution. For this, there is already a function:
source("Functions/downsample_field.R")
CORR_FIELDS <- list()
load("Data/Corr_field_HadCM3.RData")
CORR_FIELDS$HadCM3$TEMP <- downsample_field(CORR_FIELD$TEMP, 96, 48)
CORR_FIELDS$HadCM3$TEMP_P <- downsample_field(CORR_FIELD$TEMP_P, 96, 48)
CORR_FIELDS$HadCM3$PREC <- downsample_field(CORR_FIELD$PREC, 96, 48)
CORR_FIELDS$HadCM3$PREC_P <- downsample_field(CORR_FIELD$PREC_P, 96, 48)
load("Data/Corr_field_ECHAM5.RData")
CORR_FIELDS$ECHAM5$TEMP <- downsample_field(CORR_FIELD$TEMP, 96, 48)
CORR_FIELDS$ECHAM5$TEMP_P <- downsample_field(CORR_FIELD$TEMP_P, 96, 48)
CORR_FIELDS$ECHAM5$PREC <- downsample_field(CORR_FIELD$PREC, 96, 48)
CORR_FIELDS$ECHAM5$PREC_P <- downsample_field(CORR_FIELD$PREC_P, 96, 48)
load("Data/Corr_field_isoGSM.RData")
CORR_FIELDS$CCSM$TEMP <- downsample_field(CORR_FIELD$TEMP, 96, 48)
CORR_FIELDS$CCSM$TEMP_P <- downsample_field(CORR_FIELD$TEMP_P, 96, 48)
CORR_FIELDS$CCSM$PREC <- downsample_field(CORR_FIELD$PREC, 96, 48)
CORR_FIELDS$CCSM$PREC_P <- downsample_field(CORR_FIELD$PREC_P, 96, 48)
load("Data/Corr_field_CESM.RData")
CORR_FIELDS$CESM$TEMP <- downsample_field(CORR_FIELD$TEMP, 96, 48)
CORR_FIELDS$CESM$TEMP_P <- downsample_field(CORR_FIELD$TEMP_P, 96, 48)
CORR_FIELDS$CESM$PREC <- downsample_field(CORR_FIELD$PREC, 96, 48)
CORR_FIELDS$CESM$PREC_P <- downsample_field(CORR_FIELD$PREC_P, 96, 48)
load("Data/Corr_field_GISS.RData")
CORR_FIELDS$GISS$TEMP <- downsample_field(CORR_FIELD$TEMP, 96, 48)
CORR_FIELDS$GISS$TEMP_P <- downsample_field(CORR_FIELD$TEMP_P, 96, 48)
CORR_FIELDS$GISS$PREC <- downsample_field(CORR_FIELD$PREC, 96, 48)
CORR_FIELDS$GISS$PREC_P <- downsample_field(CORR_FIELD$PREC_P, 96, 48)


Model_list = c("HadCM3", "ECHAM5", "GISS", "CCSM", "CESM")
AGREE = list(TEMP = array(dim = c(96,48))+0, PREC = array(dim = c(96,48))+0)
AGREE_Points = list(TEMP = numeric(length(ENTITY_INFO$entity_id)),
                    PREC = numeric(length(ENTITY_INFO$entity_id)))

for(var in c("TEMP", "PREC")){
  for(i in 1:4){
    Model_i = Model_list[i]
    i_data = CORR_FIELDS[[Model_i]][[var]]
    i_data[CORR_FIELDS[[Model_i]][[paste0(var,"_P")]]>0.1] = NA
    for(j in (i+1):5){
      Model_j = Model_list[j]
      j_data = CORR_FIELDS[[Model_j]][[var]]
      j_data[CORR_FIELDS[[Model_j]][[paste0(var,"_P")]]>0.1] = NA
      #models
      for(lon in 1:96){
        for(lat in 1:48){
          if(is.na(i_data[lon,lat])|is.na(j_data[lon,lat])){next}
          if(sign(i_data[lon,lat]) == sign(j_data[lon,lat])){AGREE[[var]][lon,lat] = sum(AGREE[[var]][lon,lat],1, na.rm = T)}
        }
      }
      #records
      for(entity in 1:length(ENTITY_INFO$entity_id)){
        if(is.na(CORR_CAVE[[Model_i]][[paste0("p_",var)]][entity])|is.na(CORR_CAVE[[Model_j]][[paste0("p_",var)]][entity])){next}
        if(CORR_CAVE[[Model_i]][[paste0("p_",var)]][entity]<0.1 & CORR_CAVE[[Model_j]][[paste0("p_",var)]][entity]<0.1){
          if(sign(CORR_CAVE[[Model_i]][[paste0("CORR_",var)]][entity])==sign(CORR_CAVE[[Model_j]][[paste0("CORR_",var)]][entity])){
            AGREE_Points[[var]][entity] = sum(AGREE_Points[[var]][entity],1,na.rm = T)
          }
        }
      }
    }
  }
}

Model_list = c("HadCM3", "ECHAM5", "GISS", "CCSM", "CESM")
AGREE_2 = list(TEMP = matrix(0,96,48), PREC = matrix(0,96,48))
AGREE_2_Points = list(TEMP = numeric(length(ENTITY_INFO$entity_id)),
                    PREC = numeric(length(ENTITY_INFO$entity_id)))

for(Model in Model_list){
  TMP = CORR_FIELDS[[Model]]$TEMP
  TMP[CORR_FIELDS[[Model]]$TEMP_P>0.1] = 0
  AGREE_2$TEMP = AGREE_2$TEMP + 1/5*TMP
  TMP = CORR_FIELDS[[Model]]$PREC
  TMP[CORR_FIELDS[[Model]]$PREC_P>0.1] = 0
  AGREE_2$PREC = AGREE_2$PREC+ 1/5*TMP
  
  
  TMP = CORR_CAVE[[Model]]$CORR_TEMP
  TMP[is.na(TMP)] = 0
  TMP[CORR_CAVE[[Model]]$p_TEMP>0.1] = 0
  AGREE_2_Points$TEMP = AGREE_2_Points$TEMP + 1/5*TMP
  TMP = CORR_CAVE[[Model]]$CORR_PREC
  TMP[is.na(TMP)] = 0
  TMP[CORR_CAVE[[Model]]$p_PREC>0.1] = 0
  AGREE_2_Points$PREC = AGREE_2_Points$PREC + 1/5*TMP
}


#Mean_corr
#sign_agreement for more than 3 models --> point
```

Here comes the actual plot:
```{r}
plots <- list()
for(var in c("TEMP", "PREC")){
  for(Model in c("HadCM3", "ECHAM5", "CCSM", "CESM", "GISS")){
    
    name = Model
    if(Model == "CCSM"){name = "isoGSM"}
    
    Plot_lyr = CORR_FIELDS[[Model]][[var]]
    Plot_lyr_p = CORR_FIELDS[[Model]][[paste0(var, "_P")]]
    Plot_lyr[Plot_lyr_p > 0.1] = NA
    Plot_lyr[1,1] = 1
    Plot_lyr[1,2] = -1

    ##### Point Layer
    Point_Lyr <- as.tibble(CORR_CAVE[[Model]]) %>% filter(!is.na(p_TEMP)) %>% filter(p_TEMP<0.1) %>% select(entity_id, lon,lat,CORR_TEMP) %>% rename(value = CORR_TEMP)
    Point_Lyr_not <- as.tibble(CORR_CAVE[[Model]]) %>% filter(!entity_id %in% Point_Lyr$entity_id) %>% select(entity_id, lon,lat,CORR_TEMP) %>% rename(value = CORR_TEMP)
    Point_Lyr_not_p <- projection_ptlyr(as.data.frame(Point_Lyr_not %>% select(lon,lat,value)), projection = as.character('+proj=robin +datum=WGS84'))
    Point_Lyr_p <- projection_ptlyr(as.data.frame(Point_Lyr %>% select(lon,lat,value)), projection = as.character('+proj=robin +datum=WGS84'))

    #Plot
    GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE <- 4
    NA_plot_lyr = Plot_lyr
    NA_plot_lyr[!is.na(NA_plot_lyr)] = 0
    NA_plot_lyr[is.na(NA_plot_lyr)] = 1
    
    leg_name = TeX("$\\rho (T, \\delta^{18}O)$")
    if(var == "PREC"){leg_name = TeX("$\\rho (P, \\delta^{18}O)$")}

    plots[[paste0(var,"_",Model)]] <-  STACYmap_NA(gridlyr = Plot_lyr, centercolor = 0, graticules = T,
                                                   NA_gridlyr = NA_plot_lyr, NA_color = "grey", legend_names = list(grid = leg_name)) +
      geom_point(data = as.data.frame(Point_Lyr_not_p), aes(x = long, y = lat), shape = 20, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE-1.5) +
      geom_point(data = as.data.frame(Point_Lyr_p), aes(x = long, y = lat, fill = layer), shape = 21, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE) +
      theme(panel.border = element_blank(),
            legend.background = element_blank(),
            axis.text = element_blank(),
            text = element_text(size = 12),
            legend.title = element_text(size = 12))
    
    if(var == "TEMP"){
      plots[[paste0(var,"_",Model)]] = plots[[paste0(var,"_",Model)]]#+ggtitle(name)
    }else{
      plots[[paste0(var,"_",Model)]] = plots[[paste0(var,"_",Model)]]#+ggtitle(" ")
    }
    
    #which is higher plot:
    if(var == "TEMP"){
      Plot_lyr_T = CORR_FIELDS[[Model]]$TEMP
      Plot_lyr_T[CORR_FIELDS[[Model]]$TEMP_P > 0.1] = NA
      Plot_lyr_P = CORR_FIELDS[[Model]]$PREC
      Plot_lyr_P[CORR_FIELDS[[Model]]$PREC_P > 0.1] = NA
      
      Plot_lyr = abs(Plot_lyr_T)
      Plot_lyr[Plot_lyr<=abs(Plot_lyr_P)&!is.na(Plot_lyr)&!is.na(Plot_lyr_P)] = -abs(Plot_lyr_P[Plot_lyr<=abs(Plot_lyr_P)&!is.na(Plot_lyr)&!is.na(Plot_lyr_P)])
      Plot_lyr[is.na(Plot_lyr_P)] = NA
      Plot_lyr[1,1] = 1
      Plot_lyr[1,2] = -1
      NA_plot_lyr = Plot_lyr
      NA_plot_lyr[!is.na(NA_plot_lyr)] = 0
      NA_plot_lyr[is.na(NA_plot_lyr)] = 1
      
      plots[[paste0("Stronger_",Model)]] <-  STACYmap_NA(gridlyr = Plot_lyr, centercolor = 0, graticules = T,
                                                         NA_gridlyr = NA_plot_lyr, NA_color = "grey", legend_names = list(grid = TeX("max($\\rho (T,P))$"))) +
        theme(panel.border = element_blank(),
              legend.background = element_blank(),
              axis.text = element_blank(),
              text = element_text(size = 12),
              legend.title = element_text(size = 12))+
        ggtitle(" ")
      
      
    }
  }
  
  ##AGREE Plot
  
  # Plot_lyr = AGREE[[var]]
  # 
  # ##### Point Layer
  # Point_Lyr <- as.tibble(data.frame(lon = ENTITY_INFO$longitude, lat = ENTITY_INFO$latitude, value = AGREE_Points[[var]])) 
  # Point_Lyr_not <- Point_Lyr %>% filter(value == 0)
  # Point_Lyr <- Point_Lyr %>% filter(value>0)
  # Point_Lyr_p <- projection_ptlyr(as.data.frame(Point_Lyr %>% select(lon,lat,value)), projection = as.character('+proj=robin +datum=WGS84'))
  # Point_Lyr_not_p <- projection_ptlyr(as.data.frame(Point_Lyr_not %>% select(lon,lat,value)), projection = as.character('+proj=robin +datum=WGS84'))
  # 
  # #Plot
  # GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE <- 4
  # NA_plot_lyr = Plot_lyr
  # NA_plot_lyr[!is.na(NA_plot_lyr)] = 0
  # NA_plot_lyr[is.na(NA_plot_lyr)] = 1
  # 
  # leg_name = "Score"
  # #if(var == "PREC"){leg_name = TeX("$\\rho (P, \\delta^{18}O)$")}
  # 
  # plots[[paste0(var,"_agree")]] <-  STACYmap_NA(gridlyr = Plot_lyr, graticules = T, colorscheme = RColorBrewer::brewer.pal(9, 'Reds')[1:8],
  #                                               NA_gridlyr = NA_plot_lyr, NA_color = "grey", legend_names = list(grid = leg_name)) +
  #   geom_point(data = as.data.frame(Point_Lyr_not_p), aes(x = long, y = lat), shape = 20, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE-1.5) +
  #   geom_point(data = as.data.frame(Point_Lyr_p), aes(x = long, y = lat, fill = layer), shape = 21, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE) +
  #   theme(panel.border = element_blank(),
  #         legend.background = element_blank(),
  #         axis.text = element_blank(),
  #         text = element_text(size = 12),
  #         legend.title = element_text(size = 12))
  # if(var == "TEMP"){
  #   plots[[paste0(var,"_agree")]] = plots[[paste0(var,"_agree")]]+ggtitle("Agreement")
  # }else{
  #   plots[[paste0(var,"_agree")]] = plots[[paste0(var,"_agree")]]+ggtitle(" ")
  # }
  
}


#plots$TEMP_HadCM3
```

```{r}
for(var in c("TEMP", "PREC")){
    Plot_lyr = AGREE_2[[var]]

  ##### Point Layer
  Point_Lyr <- as.tibble(data.frame(lon = ENTITY_INFO$longitude, lat = ENTITY_INFO$latitude, value = AGREE_2_Points[[var]])) 
  Point_Lyr_not <- Point_Lyr %>% filter(abs(value) < 0.05)
  Point_Lyr <- Point_Lyr %>% filter(abs(value)>0.05)
  Point_Lyr_p <- projection_ptlyr(as.data.frame(Point_Lyr %>% select(lon,lat,value)), projection = as.character('+proj=robin +datum=WGS84'))
  Point_Lyr_not_p <- projection_ptlyr(as.data.frame(Point_Lyr_not %>% select(lon,lat,value)), projection = as.character('+proj=robin +datum=WGS84'))
  
  Point_Lyr_agree <- as.tibble(data.frame(lon = ENTITY_INFO$longitude, lat = ENTITY_INFO$latitude, value = AGREE_Points[[var]])) 
  Point_Lyr_agree <- Point_Lyr_agree %>% filter(value>5) %>% filter(lat %in% Point_Lyr$lat)
  if(length(Point_Lyr_agree$lon)!=0){
    Point_Lyr_agree_p <- projection_ptlyr(as.data.frame(Point_Lyr_agree %>% select(lon,lat,value)), projection = as.character('+proj=robin +datum=WGS84'))
  }
  
  Point_sig <- as.tibble(data.frame(lon = rep(seq(-180+1.875,180-1.875,3.75),48), 
                                    lat = rep(seq(90-1.875,-90+1.875,-3.75),each = 96), 
                                    value = as.numeric(AGREE[[var]])))
  Point_sig$value[Point_sig$value < 5] = NA
  Point_sig_2 <- as_tibble(data.frame(lon = Point_sig$lon[!is.na(Point_sig$value)], 
                                      lat = Point_sig$lat[!is.na(Point_sig$value)], 
                                      value =  Point_sig$value[!is.na(Point_sig$value)]))
  Point_sig_2_p = projection_ptlyr(as.data.frame(Point_sig_2, projection = as.character('+proj=robin +datum=WGS84')))


  #Plot
  GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE <- 3
  NA_plot_lyr = Plot_lyr
  NA_plot_lyr[!is.na(NA_plot_lyr)] = 0
  NA_plot_lyr[is.na(NA_plot_lyr)] = 1
  Plot_lyr[1,1] = 1
  Plot_lyr[1,2] = -1
  
  leg_name = TeX("$\\rho (T, \\delta^{18}O)$")
  if(var == "PREC"){leg_name = TeX("$\\rho (P, \\delta^{18}O)$")}

  if(length(Point_Lyr_agree$lon)!=0){
    plots[[paste0(var,"_agree")]] <-  STACYmap_NA(gridlyr = Plot_lyr, graticules = T, colorscheme = rev(RColorBrewer::brewer.pal(9, 'RdBu')[1:8]),
                                                NA_gridlyr = NA_plot_lyr, NA_color = "grey", legend_names = list(grid = leg_name)) +
    geom_point(data = as.data.frame(Point_sig_2_p), aes(x = long, y = lat), shape = 3, color = adjustcolor("black", alpha.f = 0.5), size = 0.1) + 
    geom_point(data = as.data.frame(Point_Lyr_not_p), aes(x = long, y = lat), shape = 20, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE-1.5) +
    geom_point(data = as.data.frame(Point_Lyr_p), aes(x = long, y = lat, fill = layer), shape = 21, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE) +
    geom_point(data = as.data.frame(Point_Lyr_agree_p), aes(x = long, y = lat), shape = 3, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE) +
    theme(panel.border = element_blank(),
          legend.background = element_blank(),
          axis.text = element_blank(),
          text = element_text(size = 12),
          legend.title = element_text(size = 12))
  
  }else{
    plots[[paste0(var,"_agree")]] <-  STACYmap_NA(gridlyr = Plot_lyr, graticules = T, colorscheme = rev(RColorBrewer::brewer.pal(9, 'RdBu')[1:8]),
                                                NA_gridlyr = NA_plot_lyr, NA_color = "grey", legend_names = list(grid = leg_name)) +
    geom_point(data = as.data.frame(Point_sig_2_p), aes(x = long, y = lat), shape = 3, color = adjustcolor("black", alpha.f = 0.5), size = 0.1) + 
    geom_point(data = as.data.frame(Point_Lyr_not_p), aes(x = long, y = lat), shape = 20, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE-1.5) +
    geom_point(data = as.data.frame(Point_Lyr_p), aes(x = long, y = lat, fill = layer), shape = 21, color = "black", size = GLOBAL_STACY_OPTIONS$GLOBAL_POINT_SIZE) +
    theme(panel.border = element_blank(),
          legend.background = element_blank(),
          axis.text = element_blank(),
          text = element_text(size = 12),
          legend.title = element_text(size = 12))
  
  }
}
```


Fitting it all together and also the Agreement

```{r}
# library(ggpubr)
# plot <- ggarrange(plots$TEMP_ECHAM5+theme(legend.position="none"),
#                   plots$PREC_ECHAM5+theme(legend.position="none"),
#                   plots$Stronger_ECHAM5+theme(legend.position="none"),
#                   plots$TEMP_GISS+theme(legend.position="none"),
#                   plots$PREC_GISS+theme(legend.position="none"),
#                   plots$Stronger_GISS+theme(legend.position="none"),
#                   plots$TEMP_CESM+theme(legend.position="none"),
#                   plots$PREC_CESM+theme(legend.position="none"),
#                   plots$Stronger_CESM+theme(legend.position="none"),
#                   plots$TEMP_HadCM3+theme(legend.position="none"),
#                   plots$PREC_HadCM3+theme(legend.position="none"),
#                   plots$Stronger_HadCM3+theme(legend.position="none"),
#                   plots$TEMP_CCSM, plots$PREC_CCSM,plots$Stronger_CCSM,
#                   plots$TEMP_agree, plots$PREC_agree,
#                   labels = c("(a)", "(b)", "(c)", 
#                              "(d)", "(e)", "(f)",
#                              "(g)", "(h)", "(i)", 
#                              "(j)", "(k)", "(l)",
#                              "(m)", "(n)", "(o)", 
#                              "(p) Agreement ", "(q)", "(r)"),
#                   ncol = 3, nrow = 6)
# 
# plot  %>% ggsave(filename = paste0('Manuscript_SUP_Correlation_all.pdf'), plot = ., path = 'Plots', 
#                  width = 3*10, height = 5*8, units = 'cm', dpi = 'print', device = "pdf")
# plot  %>% ggsave(filename = paste0('Manuscript_SUP_Correlation_all.png'), plot = ., path = 'Plots', 
#                  width = 3*10, height = 5*8, units = 'cm', dpi = 'print', device = "png")
# 
# plot <- ggarrange(plots$TEMP_agree, plots$PREC_agree, labels = c("a)", "b)"), ncol = 2, nrow = 1)
# plot  %>% ggsave(filename = paste0('Manuscript_SUP_Correlation_agree.pdf'), plot = ., path = 'Plots', 
#                  width = 2*10, height = 1*8, units = 'cm', dpi = 'print', device = "pdf")
# plot  %>% ggsave(filename = paste0('Manuscript_SUP_Correlation_agree.png'), plot = ., path = 'Plots', 
#                  width = 2*10, height = 1*8, units = 'cm', dpi = 'print', device = "png")
# 
# 
# #plot

```

```{r}
library(ggplot2)
library(patchwork)
txtsize = 6

row1 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label="ECHAM5-wiso", angle = 90) + theme_void() 
row2 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label="GISS", angle = 90) + theme_void() 
row3 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label="iCESM", angle = 90) + theme_void() 
row4 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label="iHadCM3", angle = 90) + theme_void() 
row5 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label="isoGSM", angle = 90) + theme_void() 
row6 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label="Agreement", angle = 90) + theme_void() 

col1 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label=TeX("$\\rho (T, \\delta^{18}O)$")) + theme_void() 
col2 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label=TeX("$\\rho (P, \\delta^{18}O)$")) + theme_void() 
col3 <- ggplot() + annotate(geom = 'text', x=1, y=1, size = txtsize, label=TeX("max($\\rho(T,P))$")) + theme_void() 


layoutplot <- "
#aaaaabbbbbccccc
deeeeefffffggggg
deeeeefffffggggg
deeeeefffffggggg
deeeeefffffggggg
deeeeefffffggggg
deeeeefffffggggg
hiiiiijjjjjkkkkk
hiiiiijjjjjkkkkk
hiiiiijjjjjkkkkk
hiiiiijjjjjkkkkk
hiiiiijjjjjkkkkk
hiiiiijjjjjkkkkk
lmmmmmnnnnnooooo
lmmmmmnnnnnooooo
lmmmmmnnnnnooooo
lmmmmmnnnnnooooo
lmmmmmnnnnnooooo
lmmmmmnnnnnooooo
pqqqqqrrrrrsssss
pqqqqqrrrrrsssss
pqqqqqrrrrrsssss
pqqqqqrrrrrsssss
pqqqqqrrrrrsssss
pqqqqqrrrrrsssss
tuuuuuvvvvvwwwww
tuuuuuvvvvvwwwww
tuuuuuvvvvvwwwww
tuuuuuvvvvvwwwww
tuuuuuvvvvvwwwww
tuuuuuvvvvvwwwww
tuuuuuvvvvvwwwww
xyyyyyzzzzz#####
xyyyyyzzzzz#####
xyyyyyzzzzz#####
xyyyyyzzzzz#####
xyyyyyzzzzz#####
xyyyyyzzzzz#####
xyyyyyzzzzz#####
"

plotlist <- list(a = col1, b = col2, c = col3, 
                 d = row1, 
                 e= plots$TEMP_ECHAM5+theme(legend.position="none")+ggtitle("a)"),
                 f = plots$PREC_ECHAM5+theme(legend.position="none")+ggtitle("b)"),
                 g = plots$Stronger_ECHAM5+theme(legend.position="none")+ggtitle("c)"),
                 h = row2,
                 i = plots$TEMP_GISS+theme(legend.position="none")+ggtitle("d)"),
                 j = plots$PREC_GISS+theme(legend.position="none")+ggtitle("e)"),
                 k = plots$Stronger_GISS+theme(legend.position="none")+ggtitle("f)"),
                 l = row3,
                 m = plots$TEMP_CESM+theme(legend.position="none")+ggtitle("g)"),
                 n = plots$PREC_CESM+theme(legend.position="none")+ggtitle("h)"),
                 o = plots$Stronger_CESM+theme(legend.position="none")+ggtitle("i)"),
                 p = row4,
                 q = plots$TEMP_HadCM3+theme(legend.position="none")+ggtitle("j)"),
                 r = plots$PREC_HadCM3+theme(legend.position="none")+ggtitle("k)"),
                 s = plots$Stronger_HadCM3+theme(legend.position="none")+ggtitle("l)"),
                 t = row5,
                 u = plots$TEMP_CCSM+ggtitle("m)"), 
                 v = plots$PREC_CCSM+ggtitle("n)"),
                 w = plots$Stronger_CCSM+ggtitle("o)"),
                 x = row6,
                 y = plots$TEMP_agree+ggtitle("p)"), 
                 z = plots$PREC_agree+ggtitle("q)"))

final_plot <- wrap_plots(plotlist, design = layoutplot)

final_plot  %>% ggsave(filename = paste0('Manuscript_SUP_Correlation_all_2.pdf'), plot = ., path = 'Plots', 
                 width = 3*10, height = 5*8, units = 'cm', dpi = 'print', device = "pdf")
final_plot  %>% ggsave(filename = paste0('Manuscript_SUP_Correlation_all_2.png'), plot = ., path = 'Plots', 
                 width = 3*10, height = 5*8, units = 'cm', dpi = 'print', device = "png")

```

